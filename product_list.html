<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“æŸ¥è©¢èˆ‡ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* é‡å°æ¸…å–®é é¢çš„é¡å¤–å¾®èª¿ */
        .product-card {
            transition: transform 0.3s, box-shadow 0.3s;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4) !important;
        }

        .card-img-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
            background-color: #f8f9fa;
        }

        .card-img-top {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .price-text {
            font-size: 1.25rem;
            color: #ff6b6b;
            /* é¡¯çœ¼çš„åƒ¹æ ¼é¡è‰² */
            font-weight: bold;
        }

        .keywords-area {
            min-height: 30px;
        }

        .card-footer {
            background-color: transparent !important;
            border-top: 1px solid rgba(255, 255, 255, 0.1) !important;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg sticky-top custom-navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">ğŸ›’ å“ç‰Œå¾Œå°ç®¡ç†ç³»çµ±</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" id="nav-ai" href="ai_generator.html">âœ¨ AI è¼”åŠ©ä¸Šæ¶</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-upload" href="product_upload.html">ğŸ“¦ å•†å“ä¸Šæ¶</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-list" href="product_list.html">ğŸ” å•†å“æŸ¥è©¢/ä¿®æ”¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-order" href="order_page.html">ğŸ“‹ è¨‚å–®é é¢</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-white fw-bold">ğŸ” å•†å“ç®¡ç†</h2>
            </div>
        </div>

        <div id="productCardContainer" class="row g-4">
            <div class="col-12 text-center py-5" id="loadingSpinner">
                <div class="spinner-border text-info" role="status"></div>
                <p class="mt-2 text-muted" style="color: #cbd5e0 !important; font-weight: 600;">è®€å–é›²ç«¯è³‡æ–™åº«ä¸­...</p>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEKrtUed8tzL1s072W9eWrTfT1RXfkOKA",
            authDomain: "test01-dd13e.firebaseapp.com",
            projectId: "test01-dd13e",
            storageBucket: "test01-dd13e.firebasestorage.app",
            messagingSenderId: "262581605790",
            appId: "1:262581605790:web:456fcca5091299e285728f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        async function loadProducts() {
            const container = document.getElementById('productCardContainer');
            const loader = document.getElementById('loadingSpinner');

            try {
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);

                if (loader) loader.remove();
                container.innerHTML = '';

                if (querySnapshot.empty) {
                    container.innerHTML = '<div class="col-12 text-center py-5 text-muted">ç›®å‰å°šç„¡ä¸Šæ¶å•†å“</div>';
                    return;
                }

                querySnapshot.forEach((documentSnapshot) => {
                    const item = documentSnapshot.data();
                    const id = documentSnapshot.id;

                    const mainImg = (item.imageUrls && item.imageUrls.length > 0)
                        ? item.imageUrls[0]
                        : 'https://via.placeholder.com/300x200?text=No+Image';

                    const date = item.createdAt ? item.createdAt.toDate().toLocaleDateString() : 'æœªçŸ¥';

                    const cardHtml = 
                    `<div class="col-12 col-md-6 col-lg-4 col-xl-3 mb-4">
                    <div class="card product-card shadow-sm h-100" style="background-color: #2d3748; border: none;">
                        <div class="card-img-container">
                            <img src="${mainImg}" class="card-img-top" alt="${item.name}">
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold text-white text-truncate mb-2">${item.name}</h5>
                            
                            <p class="card-text small mb-3" style="color: #a0aec0; height: 40px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; line-height: 1.4;">
                                ${item.description}
                            </p>
                            
                            <div class="price-text mb-2">NT$ ${item.price}</div>
                            
                            <div class="keywords-area mb-3">
                                ${(item.keywords || []).map(k => 
                                    `<span class="badge rounded-pill border border-secondary text-light me-1" style="font-size: 0.7rem; background: rgba(255,255,255,0.1);">${k}</span>`
                                ).join('')}
                            </div>
                            
                            <div class="mt-auto">
                                <small style="color: #718096;">ä¸Šæ¶æ—¥æœŸ: ${date}</small>
                            </div>
                        </div>
                        <div class="card-footer d-flex gap-2" style="background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.05);">
                            <button class="btn btn-outline-info btn-sm flex-fill edit-btn" data-id="${id}">ä¿®æ”¹</button>
                            <button class="btn btn-outline-danger btn-sm flex-fill delete-btn" data-id="${id}">åˆªé™¤</button>
                        </div>
                    </div>
                </div>`;
                    container.insertAdjacentHTML('beforeend', cardHtml);
                });

                addEventHandlers();

            } catch (err) {
                console.error("è®€å–å¤±æ•—:", err);
                container.innerHTML = `<div class="col-12 text-center text-danger py-5">è®€å–å¤±æ•—ï¼š${err.message}</div>`;
            }
        }

        function addEventHandlers() {
            // åˆªé™¤é‚è¼¯
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.getAttribute('data-id');
                    if (confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤å•†å“å—ï¼Ÿ')) {
                        try {
                            await deleteDoc(doc(db, "products", id));
                            alert('å•†å“å·²åˆªé™¤');
                            loadProducts();
                        } catch (err) {
                            alert('åˆªé™¤å¤±æ•—ï¼š' + err.message);
                        }
                    }
                });
            });

            // ä¿®æ”¹é‚è¼¯ (è·³è½‰)
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.getAttribute('data-id');
                    try {
                        const { getDoc, doc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                        const docRef = doc(db, "products", id);
                        const docSnap = await getDoc(docRef);

                        if (docSnap.exists()) {
                            const item = docSnap.data();
                            const editData = {
                                title: item.name,
                                price: item.price,
                                detail: item.description,
                                keywords: item.keywords,
                                oldImageUrls: item.imageUrls || [],
                                isEditMode: true,
                                docId: id
                            };
                            localStorage.setItem('pending_product', JSON.stringify(editData));
                            window.location.href = "product_upload.html";
                        }
                    } catch (err) {
                        alert("è®€å–å•†å“å¤±æ•—");
                    }
                });
            });
        }

        loadProducts();
    </script>

</body>

</html>