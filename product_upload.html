<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ä¸Šæ¶</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .preview-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin: 5px;
            border: 2px solid #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .ai-badge {
            display: none;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg sticky-top custom-navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">ğŸ›’ å“ç‰Œå¾Œå°ç®¡ç†ç³»çµ±</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" id="nav-ai" href="ai_generator.html">âœ¨ AI è¼”åŠ©ä¸Šæ¶</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-upload" href="product_upload.html">ğŸ“¦ å•†å“ä¸Šæ¶</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-list" href="product_list.html">ğŸ” å•†å“æŸ¥è©¢/ä¿®æ”¹</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-order" href="order_page.html">ğŸ“‹ è¨‚å–®é é¢</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-white fw-bold">ğŸ“¦ å•†å“ä¸Šæ¶</h2>
            </div>
        </div>
    </div>

    <div id="aiNotify" class="container-fluid alert alert-success ai-badge shadow-sm">
        âœ¨ <strong>åµæ¸¬åˆ°AI ç”Ÿæˆå…§å®¹ï¼å·²ç‚ºæ‚¨è‡ªå‹•å¡«å…¥å»ºè­°è³‡è¨Šï¼Œæ‚¨å¯ä»¥æ ¹æ“šå¯¦éš›æƒ…æ³å†æ¬¡å¾®èª¿ã€‚</strong>
    </div>


    <div class="container-fluid">
        <div class="row justify-content-center">
            <div>
                <div class="card upload-card shadow-sm">
                    <div class="card-body p-4">

                        <div class="form-group mb-3">
                            <label class="font-weight-bold">å•†å“åç¨± <span class="text-danger">*</span></label>
                            <input type="text" id="pName" class="form-control" placeholder="è«‹è¼¸å…¥å•†å“æ¨™é¡Œ">
                        </div>

                        <div class="form-group mb-3">
                            <label class="font-weight-bold">å•†å“èªªæ˜<span class="text-danger">*</span></label>
                            <textarea id="pDesc" class="form-control" style="height: 250px; resize: none;"
                                placeholder="è©³ç´°æè¿°å•†å“ç‰¹å¾µã€ç‰¹è‰²ã€è¦æ ¼ç­‰..."></textarea>
                        </div>

                        <div class="form-group mb-3">
                            <label class="font-weight-bold">éŠ·å”®å”®åƒ¹ (NTD) <span class="text-danger">*</span></label>
                            <input type="number" id="pPrice" class="form-control" placeholder="è«‹è¼¸å…¥å”®åƒ¹">
                        </div>

                        <div class="form-group mb-3">
                            <label class="font-weight-bold text-white">å•†å“æ¨™ç±¤<span class="text-danger">*</span></label>
                            <input type="text" id="pKeywords" class="form-control" placeholder="ä»¥ ã€éš”é–‹">

                            <div class="mt-2" id="preset-tags">
                                <span class="badge rounded-pill bg-secondary preset-tag"
                                    style="cursor: pointer;">coffee</span>
                                <span class="badge rounded-pill bg-secondary preset-tag"
                                    style="cursor: pointer;">Taiwanese Specialities</span>
                                <span class="badge rounded-pill bg-secondary preset-tag"
                                    style="cursor: pointer;">Chocolate</span>
                                <span class="badge rounded-pill bg-secondary preset-tag"
                                    style="cursor: pointer;">dessert</span>
                                <span class="badge rounded-pill bg-secondary preset-tag"
                                    style="cursor: pointer;">Sparkling Soda</span>
                                <span class="badge rounded-pill bg-secondary preset-tag" style="cursor: pointer;">Tea &
                                    Latte Selection</span>
                                <span class="badge rounded-pill bg-secondary preset-tag"
                                    style="cursor: pointer;">Caffeine-free</span>
                                <span class="badge rounded-pill bg-secondary preset-tag"
                                    style="cursor: pointer;">peripheral products</span>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label class="font-weight-bold text-primary">ä¸Šå‚³å•†å“åœ–</label>
                            <div class="custom-file">
                                <input type="file" class="custom-file-input" id="pImages" accept="image/*" multiple>
                            </div>
                            <div id="previewArea" class="mt-3 d-flex flex-wrap gap-2"></div>
                        </div>

                        <hr class="my-4" style="opacity: 0.1;">

                        <div
                            class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-3 mt-4 mb-2">
                            <button id="btn-submit" class="btn btn-primary fw-bold shadow-sm"
                                style="min-width: 220px; height: 50px;">
                                ç¢ºèªè³‡æ–™ä¸¦ç™¼å¸ƒä¸Šæ¶
                            </button>
                            <button id="btn-cancel-edit" class="btn btn-danger fw-bold shadow-sm"
                                style="display: none; min-width: 220px; height: 50px;">
                                å–æ¶ˆä¿®æ”¹ä¸¦è¿”å›æ¸…å–®
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAEKrtUed8tzL1s072W9eWrTfT1RXfkOKA",
            authDomain: "test01-dd13e.firebaseapp.com",
            projectId: "test01-dd13e",
            storageBucket: "test01-dd13e.firebasestorage.app",
            messagingSenderId: "262581605790",
            appId: "1:262581605790:web:456fcca5091299e285728f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- 1. é é¢åˆå§‹åŒ–èˆ‡æ¨™ç±¤åŠŸèƒ½ (é€™éƒ¨åˆ†ä¿®å¾©äº†ä½ çš„å•é¡Œ) ---
        window.addEventListener('load', () => {
            // A. è™•ç†æ¨™ç±¤é»æ“Š (æ”¾åœ¨é€™è£¡ç¢ºä¿ä¸è«–æœ‰æ²’æœ‰ AI è³‡æ–™éƒ½èƒ½é»æ“Š)
            document.body.addEventListener('click', function (event) {
                if (event.target.classList.contains('preset-tag')) {
                    const tagInput = document.getElementById('pKeywords');
                    if (!tagInput) return;

                    const tagName = event.target.innerText.trim();
                    const separator = 'ã€';
                    let currentVal = tagInput.value.trim();

                    if (currentVal === "") {
                        tagInput.value = tagName;
                    } else {
                        let tagsArray = currentVal.split(/[ã€,]/).map(t => t.trim());
                        if (!tagsArray.includes(tagName)) {
                            tagsArray.push(tagName);
                            tagInput.value = tagsArray.join(separator);
                        }
                    }
                    tagInput.focus();
                }
            });

            // B. è®€å– AI æš«å­˜è³‡æ–™
            const rawData = localStorage.getItem('pending_product');
            if (rawData) {
                const data = JSON.parse(rawData);
                document.getElementById('pName').value = data.title || "";
                document.getElementById('pPrice').value = data.price || "";
                document.getElementById('pDesc').value = data.detail || "";

                const tagInput = document.getElementById('pKeywords');
                if (data.keywords) {
                    if (Array.isArray(data.keywords)) {
                        // å¦‚æœæ˜¯é™£åˆ—ï¼Œç”¨ã€Œã€ã€æ¥èµ·ä¾†
                        tagInput.value = data.keywords.join('ã€');
                    } else {
                        // å¦‚æœå·²ç¶“æ˜¯å­—ä¸²ï¼Œç›´æ¥å¡«å…¥
                        tagInput.value = data.keywords;
                    }
                }

                // è™•ç†åœ–ç‰‡é è¦½
                if (data.isEditMode && data.oldImageUrls && data.oldImageUrls.length > 0) {
                    const area = document.getElementById('previewArea');
                    area.innerHTML = '';
                    data.oldImageUrls.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = 'preview-img';
                        img.style.opacity = '0.7';
                        area.appendChild(img);
                    });
                    const tip = document.createElement('div');
                    tip.className = 'small text-white w-100 ml-2';
                    tip.innerHTML = 'âš ï¸ è‹¥éœ€æ›´æ›åœ–ç‰‡ï¼Œè«‹é»é¸ã€Œé¸æ“‡æª”æ¡ˆã€é‡æ–°ä¸Šå‚³ã€‚';
                    area.appendChild(tip);
                }

                // æ¨¡å¼åˆ‡æ›é‚è¼¯
                const notifyBox = document.getElementById('aiNotify');
                const cancelBtn = document.getElementById('btn-cancel-edit');
                if (data.isEditMode) {
                    notifyBox.className = "alert alert-info ai-badge shadow-sm";
                    notifyBox.innerHTML = `ğŸ› ï¸ <strong>ä¿®æ”¹æ¨¡å¼ï¼š æ­£åœ¨ç·¨è¼¯å•†å“ã€Œ${data.title}ã€ã€‚</strong>`;
                    if (cancelBtn) {
                        cancelBtn.style.display = 'block';
                        cancelBtn.onclick = () => {
                            if (confirm("ç¢ºå®šè¦æ”¾æ£„ä¿®æ”¹ä¸¦è¿”å›å•†å“æ¸…å–®å—ï¼Ÿ")) {
                                localStorage.removeItem('pending_product');
                                window.location.href = "product_list.html";
                            }
                        };
                    }
                } else {
                    notifyBox.style.display = 'block';
                }
                notifyBox.style.display = 'block';

                // ç¶å®šé€šçŸ¥æ¡†é—œé–‰
                document.getElementById('clearAiData').onclick = () => {
                    localStorage.removeItem('pending_product');
                    location.reload();
                };
            }
        });

        // --- 2. åœ–ç‰‡é è¦½åŠŸèƒ½ (ä¿æŒåŸæ¨£) ---
        document.getElementById('pImages').addEventListener('change', function (e) {
            const area = document.getElementById('previewArea');
            area.innerHTML = '';
            [...e.target.files].forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.className = 'preview-img';
                    area.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
            const label = e.target.nextElementSibling;
            if (label) label.innerText = e.target.files.length + " å€‹æª”æ¡ˆå·²é¸å–";
        });

        // --- 3. æ­£å¼æäº¤åˆ° Firebase (ä¿æŒåŸæ¨£ä¸¦ä¿®æ­£ Keywords åˆ†éš”) ---
        document.getElementById('btn-submit').addEventListener('click', async () => {
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            const files = document.getElementById('pImages').files;
            const keywordsRaw = document.getElementById('pKeywords').value;

            if (!name || !price || !keywordsRaw) return alert("è³‡æ–™ä¸å®Œæ•´ç„¡æ³•ä¸Šå‚³");

            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "æ­£åœ¨å„²å­˜...";

            try {
                const rawData = localStorage.getItem('pending_product');
                const editInfo = rawData ? JSON.parse(rawData) : null;
                let imageUrls = [];

                if (files.length > 0) {
                    for (const file of files) {
                        const sRef = ref(storage, `products/${Date.now()}_${file.name}`);
                        const snapshot = await uploadBytes(sRef, file);
                        const url = await getDownloadURL(snapshot.ref);
                        imageUrls.push(url);
                    }
                } else if (editInfo && editInfo.oldImageUrls) {
                    imageUrls = editInfo.oldImageUrls;
                }

                const productData = {
                    name: name,
                    price: Number(price),
                    description: document.getElementById('pDesc').value,
                    // é€™è£¡ä¿®æ­£ç‚ºä¾ç…§ã€Œã€ã€æ‹†åˆ†é™£åˆ—
                    keywords: keywordsRaw ? keywordsRaw.split('ã€').map(k => k.trim()) : [],
                    imageUrls: imageUrls,
                    updatedAt: serverTimestamp()
                };

                if (editInfo && editInfo.isEditMode && editInfo.docId) {
                    await updateDoc(doc(db, "products", editInfo.docId), productData);
                    alert("âœ… ä¿®æ”¹æˆåŠŸ");
                } else {
                    productData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "products"), productData);
                    alert("âœ… æ–°å¢æˆåŠŸ");
                }

                localStorage.removeItem('pending_product');
                window.location.href = "product_list.html";
            } catch (err) {
                alert("å„²å­˜å¤±æ•—ï¼š" + err.message);
                btn.disabled = false;
                btn.innerText = "ç¢ºèªè³‡æ–™ä¸¦ç™¼å¸ƒä¸Šæ¶";
            }
        });

        window.addEventListener('pagehide', () => {
            localStorage.removeItem('pending_product');
        });
    </script>

</body>

</html>