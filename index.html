<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonlight Café 後台管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg sticky-top custom-navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand">🛒 商店後台管理系統</a>
        </div>
    </nav>

    <div class="container mt-5">
        <div id="login-section" class="text-center py-5">
            <h2 class="mb-4"><strong>請使用已認證身分登入</strong></h2>
            <p class="text-muted"><strong>本系統僅供授權管理員使用</strong></p>
            <button id="login-btn" style="
                background-color: rgb(205, 211, 225); 
                border: 3px solid #1e3a72; 
                border-radius: 8px;
                align-items: center;
                justify-content: center;
                padding: 10px 60px;
            ">
                <img src="./images/google.webp" alt="Google 登入" style="width: 150px;">
            </button>
        </div>

        <div id="admin-content" style="display: none;">
            <div class="alert alert-success">
                歡迎回來，<span id="admin-name" class="fw-bold"></span>！您已成功進入商家後台系統。
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">管理選單</h5>
                            <p class="card-text">您現在可以進行商品管理與訂單監控。</p>
                            <a href="product-management.html" class="btn btn-dark">進入商品管理</a>
                            <a href="order-monitor.html" class="btn btn-dark">查看即時訂單</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 引入 Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        // 【修正 1】增加 setPersistence 與 browserSessionPersistence 的導入
        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            onAuthStateChanged,
            signOut,
            setPersistence,           // 必須導入
            browserSessionPersistence // 必須導入
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase 專案配置
        const firebaseConfig = {
            apiKey: "AIzaSyAEKrtUed8tzL1s072W9eWrTfT1RXfkOKA",
            authDomain: "test01-dd13e.firebaseapp.com",
            projectId: "test01-dd13e",
            storageBucket: "test01-dd13e.firebasestorage.app",
            messagingSenderId: "262581605790",
            appId: "1:262581605790:web:456fcca5091299e285728f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // 設定管理員白名單
        const adminEmails = ["moonlightcafe.com@gmail.com"];

        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');
        const adminNameSpan = document.getElementById('admin-name');

        // 監聽登入狀態改變
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // 檢查是否在管理員白名單內
                if (adminEmails.includes(user.email)) {
                    console.log("驗證成功，準備跳轉...");

                    // 更新 UI (選擇性，因為即將跳轉)
                    adminNameSpan.textContent = user.displayName;

                    // 【關鍵】登入成功後跳轉至指定頁面
                    // 使用 setTimeout 稍微延遲，確保 Firebase 狀態已完全寫入
                    setTimeout(() => {
                        window.location.href = "order_page.html";
                    }, 500);

                } else {
                    // 已登入但非管理員
                    alert("權限不足：您的帳號並非授權商家。");
                    signOut(auth);
                }
            } else {
                // 未登入狀態
                loginSection.style.display = 'block';
                adminContent.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        });

        // 登入事件
        loginBtn.onclick = async () => {
            try {
                // 確保先設定持久化策略，再執行登入
                await setPersistence(auth, browserSessionPersistence);
                await signInWithPopup(auth, provider);
                console.log("登入成功");
            } catch (error) {
                console.error("登入錯誤代碼:", error.code);
                console.error("錯誤訊息:", error.message);
                alert("登入失敗，請查看控制台報錯。");
            }
        };

        // 登出事件
        logoutBtn.onclick = () => {
            signOut(auth).then(() => {
                window.location.reload();
            });
        };
    </script>
</body>

</html>