<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moonlight Café 後台管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg sticky-top custom-navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand">🛒 商店後台管理系統</a>
        </div>
    </nav>

    <div class="container mt-5">
        <div id="login-section" class="text-center py-5">
            <h2 class="mb-4"><strong>請使用已認證帳號登入</strong></h2>
            <h5 class="text-muted mb-4"><strong>本系統僅供授權管理員使用</strong></h5>
            <button id="login-btn" style="
                background-color: rgb(237, 238, 242); 
                border: 3px solid #1e3a72; 
                border-radius: 8px;
                align-items: center;
                justify-content: center;
                padding: 10px 60px;
            ">
                <img src="./images/google.webp" alt="Google 登入" style="width: 150px;">
            </button>
        </div>

        <div id="admin-content" style="display: none;">
            <div class="alert alert-success">
                歡迎回來，<span id="admin-name" class="fw-bold"></span>！您已成功進入商家後台系統。
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">管理選單</h5>
                            <p class="card-text">您現在可以進行商品管理與訂單監控。</p>
                            <a href="product-management.html" class="btn btn-dark">進入商品管理</a>
                            <a href="order-monitor.html" class="btn btn-dark">查看即時訂單</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 引入 Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        import {
            getAuth,
            signInWithPopup,
            GoogleAuthProvider,
            onAuthStateChanged,
            signOut,
            setPersistence,
            browserSessionPersistence
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase 專案配置
        const firebaseConfig = {
            apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
            authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
            projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
            storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
            messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
            appId: import.meta.env.VITE_FIREBASE_APP_ID
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // 設定管理員白名單
        const adminEmails = ["moonlightcafe.com@gmail.com"];

        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');
        const adminNameSpan = document.getElementById('admin-name');


        onAuthStateChanged(auth, (user) => {
            if (user) {
                // 檢查是否在管理員白名單內
                if (adminEmails.includes(user.email)) {
                    console.log("驗證成功，準備跳轉...");
                    // 更新 UI
                    adminNameSpan.textContent = user.displayName;
                    window.location.href = "order_page.html";

                } else {
                    // 非管理員
                    alert("權限不足：您的帳號並非授權商家。");
                    signOut(auth);
                }
            } else {
                // 未登入狀態
                loginSection.style.display = 'block';
                adminContent.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        });

        // 登入事件
        loginBtn.onclick = async () => {
            try {
                await setPersistence(auth, browserSessionPersistence);
                await signInWithPopup(auth, provider);
                console.log("登入成功");
            } catch (error) {
                console.error("登入錯誤代碼:", error.code);
                console.error("錯誤訊息:", error.message);
                alert("登入失敗");
            }
        };

        // 登出事件
        logoutBtn.onclick = () => {
            signOut(auth).then(() => {
                window.location.reload();
            });
        };
    </script>
</body>

</html>